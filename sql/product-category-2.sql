--second batch
set serveroutput on size 1000000;
declare
   cursor c_global_id
    is
        select global_id
        from end_frg_content_data
        where global_id in (1001004011826500,1001004011445559,9200000019683120,9200000011698580,1000004011795338,1000004011742189,9200000024503348,1001004005587705,1000004011320368,1002004006741804,1001004000735556,1001004002579959,1001024187363240,1001004004485320,9200000011254755,1000004013391636,9200000009984320,1001024226577226,9200000010029258,1001024229491602,1001024253952778,1000004003196361,1001024242580120,1000004002308819,1000004003012145,9200000025043476,1001024226832750,1002004000083994,1001024252775116,1002004013031845,1002004000079188,1001004001853374,9200000018283646,9200000010855283,9200000005191428,9200000010855301,9200000025808021,9200000002307368,1001004006279476,9200000021806280,9200000000037821,9200000022837561,1000004006886645,1000004010637681,1000004012161583,9200000016157699,1001024236055963,1001004000786732,1001004000945854,1001004000812047,1001004010309652,9200000005182135,1001024255400479,1001024262693629,9200000011681147,1004004012234917,9200000013557933,9200000022700710,1001004001241560,1001004004798428,1001004006220367,1001004007798797,1001004009903516,1001024254816607,1002004012518616,9200000014354387,1001024248193499,1001024248193572,1002004000084388,1001004000802233,9200000011384396,1001004006191799,9200000004735901,9200000011257939,1000004001149864,1000004007477184,9200000001279184,9200000002307383,9200000021739168,9200000010744950,9200000002307368,1001004011270074,9200000002307364,9200000000666823,1001024241774915,9200000010695889,9200000018825652,1000004004286265,1000004004278442,1000004012085934,1000004000054525,1001024263208384,1000004000067820,1000004006421479,9200000010925556,1001004010313613,1001004002606852,1001004008504106,9200000026406069,9200000005271561,9200000005271577,9200000002224174,1001024234932346,9200000002223033,1000004007112979,1000004012323316,1000004012212914,9200000022701224,9200000026169207,9200000026319647,1000004000002447,1000004003139120,9200000015463997,1000004011742103,9200000026769551,9200000026195967,9200000025427106,9200000010161740,1004004013657713,1004004013579335,9200000005544674,9200000015316406,1001024119656130,9200000019688132,1002004013680574,9200000011135399,1001024260031250,1004004004575903,1001004009989018,1002004006518688,2002048010741074,1001024248178480,9200000016502044,9200000017123119,9200000025828328,1002004011751294,1001024096372969,1001024190215161,1001024246064644,9200000010843059,9200000005931973,9200000005931947,9200000010855303,9200000007572805,9200000007572819,9200000010855293,1004004012448229,1002004012186337,1002004013268788,9200000014025318,9200000011257939,1001004006191799,9200000004735901,1001004011437922,9200000024926193,1001024263209046,9200000021970647,9200000005399520,1001024197966720,1001004001981954,1001004006858959,1001024261723039,1001024224534050,1004004013691556,1001024252434588,1001024023106933,1002004000093320,9200000015453298,9200000026319647,9200000026195967,9200000008856412,9200000018521669,1000004011163844,1001024029167467,1001024260514960,9200000025069956,1001024263331594,1001004011822891,9200000005033522,9200000005227727,9200000018304863,1001024251886575,9200000024666683,9200000010047148,1001024124507631,1001024219676359,9200000014944671,9200000010531645,9200000005931981,1001024263618207,1001024172301862,1001024242024525,1001024118823403,9200000026196003,1000004006537662,9200000019211858,9200000012512977,1001004002628969,9200000005505590,9200000010504291,1001024263091899,1002004011838583,9200000021842101,9200000018727595,1002004012276464,1002004006564186,9200000016778638,9200000023509326,1000004013254212,9200000022477242,9200000010993819,9200000010993827,9200000010993678,9200000010993793,9200000010993799,1001004004930307,1001004004930308,1001004004930306,1001004004930310,1001024262292206,1001024257536791,9200000000938966,9200000015466754,9200000011675423,1001024189362902,9200000005286511,9005000010493876,9200000022700710,9200000022506924,9000000010993259,9200000005177966,9200000005177557,9200000010827255,1001024260499488,1001004006858991,1001004006540810,1001004011523484,9000000011666969,9200000004735901,9200000011406160,9200000018219826,9200000010110307,9200000018315425,9200000009436121,9200000018792563,9200000015320126,9200000007565154,1001004011050878,9200000026831839,9200000018547284,1001024155378600,1001004001686953,1002004004809874,1001004002775168,1001024258484751,1002004004436962,1001024201296157,1002004005939193,1002004011962156,1001024255878297,9200000011356731,9200000011097917,1001024257491445,1000004005378903,9200000019683120,1001024222813547,1001004011587822,1001004000877147,1001004001794581,1001004002170449,1001004007449210,1001004000679775,1004004011473109,9200000022092064,1000004007100387,9200000019404774,1001004005964356,1001004007495514,1001004006227664,1001004006051442,9200000002142196,9200000005933133,1001024263094035,1001004001831947,9200000022063983,9200000022064283,1002004011582542,9200000020992585,1002004000101348,1002004006145678,1001004004468301,1001004002949290,1001004001386027,1001024252953648,9200000010587388,1001004008487126,9200000008484920,1001024263459200,9200000015014372,9200000008555329,9200000011891817,9200000005181886,1002004005935590,1002004006822428,9000000007957432,9000000009990856,9200000005185827,9200000009422021,1001004001241561,1001004000968194,9200000022412448,9200000022205837,1001024255774688,1001024255773435,1004004010594335,1004004012309718,9200000011366809,9200000026249452,1000004003100299,9200000007566752,1001004005039504,1001004010981670,9200000010376150,1001004011822900,1001024013714303,9200000011450744,9000000010993408,9000000011035380,9200000005138905,9200000021752065,1001004010599286,1001004011721736,1001024197437589,1001024262751405,9200000002938535,9200000010969160,9200000011087711,1004004012189992,1002004008667817,9200000001444481,1004004012190031,1002004010601186,9200000020435799,1001024210618077,1001004003005883,9200000023423493,9200000005505590,9200000011257939,1001024255375404,1001004011653527,1002004012212719,9200000024527876,1002004010467867,9200000020876403,9200000015479713,9200000011254964,1001024256941791,9200000020370237,9200000013345379,1001004002652902,9200000005529202,1001024254188217,9200000010497077,1001024263092354,9200000022092064,1001004006227664,1000004006227230,1001024085052610,1000004011396594,1002004004848344,1001024262734083,1001004010901719,1001024254067180,1001024082114983,9200000011398791,9200000026640000,9200000022469102,9200000025353129,1001004005511840,1001004007590486,1001024244421120,1001024265903569,9200000018790838,1004004012065971,1001024266820757,1002004000077807,1002004011739956,1002004012558346,1002004011185412,9200000012130468,1001004005731024,1001004002114910,1001004002590041,1001004001241561,1001024223721015,1001024246734813,1002004000125386,9200000023062435,1001024214689094,9200000026768512,9200000021822427,1001024252669927,1001024252669932,1002004005043771,1002004012095358,1002004013514735,9200000014299745,1004004013408154,9200000026344659,9200000008982159,9200000015434493,9200000005386013,9200000021794396,1001024226555026,1001024225358681,9200000025959743,9200000026260436,9200000022230468,9200000022055425,1001004002409604,1002004013232657,9200000020077577,9200000016498635,1000004013713990,1003004012010518,9200000015509297,9200000000032974,1001024262342000,1001024063778766,1001004010951328,1001024246832893,9200000005926020,1004004011994905,1001024192217639,1004004011731814,1001004001976456,9000000012437292,1001024270079069,9200000027341399,1001004006385225,9200000006524762,1001004006309251,1001024241517677,1001024190826123,9200000011257939,9200000011097917,1001024260419699,1001024254820365,9000000010993408,9000000011035380,9200000020049256,9200000015334149,9200000015334116,9200000006635555,9200000006635553,9200000011043095,9200000020370201,9200000011499829,1001024108444218,1001024264591324,9200000022074337,1002004000115806,9200000022070835,9200000011388379,9200000011388373,9200000011388371,9200000020328603,9200000022853926,9200000005191456,9200000018326932,9200000013301183,1004004012091490,1002004004448843,1000004006229679,9200000005478917,1001024124050041,1001024114480090,1001024260328410,1001024252681098,1001024204305904,9200000002617232,1002004007157307,9200000001236546,9200000013568885,1001024086257451,1001004001575374,9200000022841001,1001024237966729,1001024260380974,1001024256871754,1001024256740113,1001004007800726,1002004012261163,9200000015502514,1002004011450451,1002004010534866,1001024187100479,1001024120589977,1002004006740840,9200000019688114,9000000011742236,1001024091489076,1001024076626943,9200000019497402,9200000021548450,1001024226553982,9200000020682963,9200000020337976,1002004013291298,1000004001797885,9200000020504444,9200000026464557,9200000027133591,9200000010559165,9200000018792563,9200000018301976,9200000025449809,1000004000059910,1001024231650171,1001024264571055,9200000021756572,1001004006413648,9200000011326161,9200000004375326,9200000005529132,9200000024537289,9200000021155871,1000004001205179,1000004013359734,9200000025828328,1001004001241560,1002004000096480,1001004001241560,1003004004216707,1001024220346945,1001004011502005,1001024262977351,1002004007157314,9200000021843263,9200000023968796,9200000012027705,9200000006550210,9200000021924448,9200000009423286,1001024245413239,1001024241472391,1002004012393860,9200000022725938,9200000022857652,1000004013469945,1000004006404227,1001004005574586,1001024248998897,1001024267667663,1002004013286740,9200000011326175,9200000022477242,1002004013673854,9200000022666673,9200000014976186,1002004011270624,9200000025795984,1000004001205179,1001024225041414,1002004007108289,1001024088096174,1001024248723383,1002004008564061,1001024119038360,1002004006540278,1002004010898541,1001004002543728,1001004005637914,1001024088882525,9200000025955303,1001004009993122,1001024260316456,1001024175279382,1001024264666271,1001024264665494,1001024265073195,1001024264665373,1002004011698311,1001024268667440,9200000019244977,1002004009799062,9200000010739945,9200000014299279,9200000013981766,9200000014299279,9200000014299279,9200000016499920,9200000011325825,1001024273284964,9200000024749059,9200000026339687,1004004011473592,9200000007087856,9200000007087814,9200000007087652);
        
   type g_idtype is table of c_global_id%rowtype;
   
   g_id g_idtype;
   
   TYPE result IS RECORD
   (
      id                  varchar2(10),
      global_id           VARCHAR2(16),
      category_id         VARCHAR2(10),
      category_desc       VARCHAR2(100)
   );

   cat            varchar2(10);
   catd            varchar2(100);
   subtype num is varchar2(10);
   type tab_type is table of result index by num;
   tab tab_type;
   i     number(10);
   t_idx pls_integer;
    v_filehandle utl_file.file_type;
    
   
begin
   open  c_global_id;
   fetch c_global_id bulk collect
   into  g_id;
   close c_global_id;
    
    i := 1;
    t_idx := g_id.first; 
    
    --v_filehandle := utl_file.fopen('U:\','product-category.txt','a');--Opening a file
          
    while g_id.exists(t_idx)
    LOOP
            tab(i).id := to_char(i);
            tab(i).global_id := g_id(t_idx).global_id;
            
            select REGEXP_SUBSTR(revPath, '[^,]+', 1, 1) into cat
            from
            (
            with relation(parent_id,id) as
            (
            select parent_id, id
            from end_shelf_definitions
            )
            SELECT ListAgg(id,',')
                   within group(order by Level desc) as revPath
            FROM relation
            START WITH id = (select shelf_id from end_shelf_products where global_id = g_id(t_idx).global_id and rownum = 1)
            CONNECT BY PRIOR parent_id = id
            and id <> 1
            );
            
            select nvl(description,'')  into catd
            from end_shelf_definitions where id = nvl(cat,1);
            
            
            tab(i).category_id := cat;
            
            tab(i).category_desc := catd;
            
            dbms_output.put_line(g_id(t_idx).global_id || ',' || catd); 
            
            i := i + 1;
            t_idx := g_id.next(t_idx);
    
            --utl_file.putf(v_filehandle,'%s, %s\n',g_id(t_idx).global_id, catd);                    
            --utl_file.new_line(v_filehandle);
    END LOOP;
    
    --UTL_FILE.fclose(v_filehandle);

end;        


