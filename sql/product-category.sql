set serveroutput on size 1000000;
declare
   cursor c_global_id
    is
        select global_id
        from end_frg_content_data
        where global_id in (1002004013134176,1001024221833402,9200000016170503,1001004002381877,9200000022121543,9200000007691703,9200000024753923,1001024226454039,9200000024458242,9200000011562111,9200000025793084,1001024246481810,9200000018280144,9200000017138461,9200000026405703,9200000026405819,9200000010014502,1001004001241560,1001024154432287,1001004002475391,1001024182710964,1001024099445624,1001004006184441,1004004007096475,9200000026498600,666793729,666793730,666793731,666843534,666793733,9200000026321260,9200000003577763,9200000008135827,1001004007283952,666837523,1001004002050337,1001004005008010,1001004011313203,9200000024806647,9200000022477242,9200000022230426,1001024259991485,1001024202040991,1001004010938647,9200000013724784,9200000021843361,9200000015346210,1001004011522982,1002004013597978,1002004013673563,1002004005043780,9200000021970022,9200000024631812,9200000025450305,1001004011707392,1001024249318641,1002004011737157,1001024216002070,1001024197613786,9200000011254727,1002004007168456,9200000002233873,666780458,1001004002369030,1001004006024994,9000000010316565,1001024251464677,9200000015479601,1004004006565097,9200000016170752,9200000014682965,1004004007689930,1001024255670743,1001004006051442,9200000010046952,9200000016499938,9200000022477230,1002004013286740,1000004010500404,1000004013448674,1000004012438693,1000004011023874,1000004005875790,1000004001965709,9200000010560384,9200000000033474,9200000008137283,9200000018327994,9200000025069956,9200000019411565,1002004013344452,1002004011526467,1002004010606483,1002004007104340,1002004009713999,1002004009714000,1002004004438092,1002004006260450,1001024213014022,9200000011134209,9000000011789525,1002004011307042,1001024054107494,9200000007391951,9200000025083044,1001024086596393,1000004013041393,1001024205108334,1001024105318931,9200000005250133,9200000012143692,1001024250579705,9200000019688094,9200000018251925,9200000022074381,9200000008934316,9000000012677979,1001024246480190,1001004009233011,1001004001241560,1002004009792371,1001024260417493,1001024243889420,1001024126734979,1001024083155865,1002004009900284,1002004006449785,1001024249276175,9200000013361191,1001024260461659,9200000010395848,9200000010400348,9200000010406109,9200000010406103,9200000022854071,1001024249217998,9200000010404115,9200000010828615,1001024227275193,9200000010412800,1002004004390007,9200000023055235,9200000010719717,9200000005399520,9000000012256702,9200000022666731,9200000022701224,1000004011379908,1001004002475391,1001004001241560,666828291,9200000021970022,666828291,9200000021756735,1002004012335458,9200000021760628,9200000022220160,9200000022220274,9200000006635553,9200000006635555,2002048004281778,1001024243738457,1004004011310830,9000000012262624,1001024217360736,9200000011257939,1001024217360755,1004004011823291,9200000015373879,1004004013382088,1001024237244301,1001024237244301,1001024256434819,1001004011831304,1001004004931506,9200000017140128,1000004013327995,1001024226875649,9200000010409036,9200000010409034,9200000019401710,1004004012091490,9200000024516595,9200000022055339,9200000002307383,9200000000613997,1001024088104329,1001024259644605,9200000025046545,9200000022108350,1002004004413399,9200000024508457,1002004007112144,1002004000080194,1001024016631935,1004004011928038,1001004005378104,1001004005378105,1001004005378106,1001024204151527,9200000018311159,1001004006192024,1001024241985370,9200000023081633,1001004002853911,1001024254364860,1001024243518210,9200000005191596,9200000014669954,9200000005557490,1003004012437373,1000004012047662,1001024114932646,1002004011591161,9200000026132893,9200000010861684,9200000005178939,9200000005033814,9200000007343808,9200000005182111,9200000005033984,1002004000035765,1002004000035764,1001024210617403,9200000022477230,1002004000037102,9200000007510923,9200000014373827,9200000021978094,1001024252216270,9200000026335348,1004004004539911,1000004006242272,9200000005033405,9200000018601435,9200000024793695,1004004013546365,9200000010236018,9200000023850309,9200000011694581,9200000011675414,9200000024927933,1001004001241560,1004004013408154,9200000024258199,1002004013468413,1002004011032885,1001024079854439,9200000022117936,1002004013068313,1001024239720159,9200000019067911,1003004006397225,1001024247783922,1001024237742629,9200000026151629,1001004001110793,1001024037112217,1004004013252006,1004004012043951,1004004013628938,9200000021800301,9200000025880251,9200000015316400,9200000008111486,9200000016515284,1001004008802494,1002004000083457,9200000020992075,9200000008611897,9200000008611853,1001004011667752,1001004011667740,9200000009681207,1001004011667739,9200000005187412,9200000025548201,9200000011326115,1001004011784518,1001004011806669,9200000022091731,9200000005539929,1002004012173291,9200000023128239,9000000011813659,1001004006554096,1001004006554070,1001004006554097,1001004006566780,1001004006238509,1001004006573769,1001004009688259,1001004010611962,1001004011283158,9200000002272925,9200000010920476,1001024259928411,1001024013718095,1000004003214430,1001004007514576,1002004009042290,1001024254820365,1001024213873772,1001024260419699,1001024226574461,9200000010840548,9200000015318461,9200000005192279,9200000005192285,1001024248996439,1002004004679350,1001004010723747,1001004002125259,1001004010900985,1002004012448182,1001024246768645,1001004004798428,1001004005492244,666835376,1002004013605730,9200000021930920,666850786,666871530,1001024255947824,9200000019482509,9200000005557446,9200000011698623,9200000018333868,9200000005181880,1001024114899625,1001024257492776,9200000022065708,1002004010700788,9200000009652085,1004004013468197,1001004001241561,1001004006304225,1001024235027019,1001024159191881,1000004012252408,9200000015511682,1001004005472199,1001004007581408,1001004011259044,9200000023862801,1001004006304225,1002004013286740,9200000009649417,1001004011496700,1001004001140436,666865696,1000004006227230,9200000020992675,9200000019688132,1002004013441493,1001024247811068,1001024248076560,9200000025469816,9200000019649529,1001004004448460,9200000009985082,1001004004542686,1001024177890761,9200000015233238,9200000002652299,1004004013556912,9200000026508142,9200000005173930,9200000009596402,9200000015324038,666857839,666872192,9200000021747282,9200000015506756,1004004012546076,1004004012120630,9200000018856414,9200000011060200,1001004011542685,1001024260416851,9200000009834271,9200000021747343,9200000026257198,9200000015337025,9200000020136143,1002004010214556,9200000015356453,1002004012010757,1002004011342744,9200000018115372,1001004001241561,1001024262962686,9200000020907483,1001024262763809,1001024263538306,9200000025046545,9200000005173181,1002004012340162,1002004012178654,1001024257881605,1002004005493544,1002004006591210,9200000015480398,1002004013268558,1001004002122235,1004004004223217,1001004001241560,9200000021226906,9200000011243798,9200000002061804,9200000002061806,9200000010220590,1001024192274502,9200000010559155,9200000022071011,9200000021970762,9200000011128009,9200000026257152,9200000009652562,1001004002928507,1002004012415112,1000004011325372,1001024259791843,1002004005357900,1001004002594739,9200000002757923,9200000003349358,9200000020314773,1001004009058329,9200000008629096,9200000020338321,9200000009380351,9200000015581045,1001024236154416,1001004011175550,1001004006208377,1002004011628947,1002004011729258,9200000020471235,1001004002763874,9200000009850434,1001004010312723,9200000021765980,1001004007506696,9200000009984178,9200000021765952,1001004002382077,1001004004724463,1001004002382078,1001004004724462,1001004011826500,1001004011826499,9200000015511614,1001004002114910,1001024242514691,1001024091691306,1001024154029693,9200000005800192,1001004001241560,1001024194956141,1001024199371086,1001024252967227,1001004006227664,9005000011616494,1001024261139094,9200000006576018,9200000006576028,9200000006576624,9200000006576642,9200000011812152,9200000013729671,9200000011812287,9200000011687563,9200000014384689,9200000017132958,9200000009672821,9200000009502869,1001024096372788,9200000010752229,1001004000788751,1002004004486581,1002004012434777,9200000014682989,9200000000050756,9200000015314232,1001004007800726,9200000019680929,1000004003169434,1001024226565836,1001024255374433,9200000020431881,9000000011197579,1001024251103498,9200000026257152,9200000022485276,9200000022055333,1004004012439451,9200000025424283,1001004002713440,1001004006827922,1001004006248242,9200000002674284,1001004006231738,1001024256000214,9200000015316434,1002004012184461,1001004011604368,1001004010531314,9200000005478917,1001024248859709,9200000016497755,9200000016498019,9200000013742919,9200000013743030,1001004001763566,1004004012018860,1004004007136883,9200000011832221,9200000026768512,9200000021822427,1001024252669927,1001024252669932,1001024191488689,9200000021530827,9200000010993668,9200000010993672,9200000010993654,1001004005378104,1001004005378106,1001004005962642,9200000011411193,9200000002274867,9200000016321375,666790907,1001004010944003,1001004010487199,1000004007507906,1000004010486511,1000004003052086,9200000016023462,1001004011696651,9200000008497606,9200000021818275,1001004001173554,9200000010991980,9200000000038043,9200000026196003,1001024260021562,1001024258919588,1001024248704410,1001024258928063,1001024262924458,1001024233139749,1001024183941810,1001024246033602,1001024219569487,1001024234344961,1001024258919559,1001024257867375,1001024249463373,1001024245371792,1001024248890734,1001024263418518,1001004011437922,1001024027408798,9200000011257939,9000000009990856,9200000010123876,9200000008859788,9200000002015393,1002004013301614,1001004002942295,9200000022071551,1001004000579844,1001024209348752,9200000016502044,1001024257911500,1001024249041567,1001024260286067,1001004001931438,1001004010901719,1002004013406817,1001024243730837,9200000020712044,1001024204370122,1000004005378903,9000000011157865,9200000020338321,1001004001840125,9200000020448323,1001004006067894,1004004013550927,9200000025955303,1001004011449297,9200000021765980,1001004007506696,9200000021765952,9200000009984178,9200000015511614,1001004011826499);
        
   type g_idtype is table of c_global_id%rowtype;
   
   g_id g_idtype;
   
   TYPE result IS RECORD
   (
      id                  varchar2(10),
      global_id           VARCHAR2(16),
      category_id         VARCHAR2(10),
      category_desc       VARCHAR2(100)
   );

   cat            varchar2(10);
   catd            varchar2(100);
   subtype num is varchar2(10);
   type tab_type is table of result index by num;
   tab tab_type;
   i     number(10);
   t_idx pls_integer;
    v_filehandle utl_file.file_type;
    
   
begin
   open  c_global_id;
   fetch c_global_id bulk collect
   into  g_id;
   close c_global_id;
    
    i := 1;
    t_idx := g_id.first; 
    
    --v_filehandle := utl_file.fopen('U:\','product-category.txt','a');--Opening a file
          
    while g_id.exists(t_idx)
    LOOP
            tab(i).id := to_char(i);
            tab(i).global_id := g_id(t_idx).global_id;
            
            select REGEXP_SUBSTR(revPath, '[^,]+', 1, 1) into cat
            from
            (
            with relation(parent_id,id) as
            (
            select parent_id, id
            from end_shelf_definitions
            )
            SELECT ListAgg(id,',')
                   within group(order by Level desc) as revPath
            FROM relation
            START WITH id = (select shelf_id from end_shelf_products where global_id = g_id(t_idx).global_id and rownum = 1)
            CONNECT BY PRIOR parent_id = id
            and id <> 1
            );
            
            select nvl(description,'')  into catd
            from end_shelf_definitions where id = nvl(cat,1);
            
            
            tab(i).category_id := cat;
            
            tab(i).category_desc := catd;
            
            dbms_output.put_line(g_id(t_idx).global_id || ',' || catd); 
            
            i := i + 1;
            t_idx := g_id.next(t_idx);
    
            --utl_file.putf(v_filehandle,'%s, %s\n',g_id(t_idx).global_id, catd);                    
            --utl_file.new_line(v_filehandle);
    END LOOP;
    
    --UTL_FILE.fclose(v_filehandle);

end;        


